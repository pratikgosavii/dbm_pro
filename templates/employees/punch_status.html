{% load static %}

<div class="animate__animated animate__fadeIn">
    {% if today_attendance and today_attendance.punch_in_time and not today_attendance.punch_out_time %}
        <!-- User is punched in, show timer and punch out button -->
        <div class="card mb-2 border-success">
            <div class="card-body p-2 text-center">
                <p class="mb-1 fw-bold">Punched in at {{ today_attendance.punch_in_time|time:"H:i" }}</p>
                <div id="work-timer" class="mb-2 fs-5 fw-bold text-success" 
                     data-punch-in="{{ today_attendance.punch_in_time|time:'H:i:s' }}">
                    00:00:00
                </div>
                <div class="progress mb-2" style="height: 5px;">
                    <div id="time-progress" class="progress-bar bg-success" style="width: 0%"></div>
                </div>
                <a href="{% url 'employees:punch_out' %}" class="btn btn-sm btn-danger w-100">
                    <i class="fas fa-sign-out-alt me-1"></i> Punch Out
                </a>
            </div>
        </div>
    {% elif not today_attendance or not today_attendance.punch_in_time %}
        <!-- User is not punched in, show punch in button -->
        <a href="{% url 'employees:punch_in' %}" class="btn btn-sm btn-success w-100 mb-2">
            <i class="fas fa-sign-in-alt me-1"></i> Punch In
        </a>
        <p class="small text-muted mb-0">Required: 9 hours daily</p>
    {% else %}
        <!-- User has already punched out today -->
        <div class="card mb-2 border-secondary">
            <div class="card-body p-2 text-center">
                <p class="mb-1">Today's work</p>
                <p class="mb-1 fw-bold">
                    {{ today_attendance.punch_in_time|time:"H:i" }} - 
                    {{ today_attendance.punch_out_time|time:"H:i" }}
                </p>
                <p class="mb-0 small text-muted">
                    Total: {{ today_attendance.hours_worked|floatformat:2 }} hours
                    {% if today_attendance.hours_worked >= 9 %}
                        <span class="text-success"><i class="fas fa-check-circle"></i></span>
                    {% else %}
                        <span class="text-warning"><i class="fas fa-exclamation-circle"></i></span>
                    {% endif %}
                </p>
            </div>
        </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const timerElement = document.getElementById('work-timer');
    const progressElement = document.getElementById('time-progress');
    
    if (timerElement) {
        const punchInTime = timerElement.dataset.punchIn.split(':');
        const punchInDate = new Date();
        punchInDate.setHours(parseInt(punchInTime[0], 10));
        punchInDate.setMinutes(parseInt(punchInTime[1], 10));
        punchInDate.setSeconds(parseInt(punchInTime[2], 10));
        
        function updateTimer() {
            const now = new Date();
            const diffMs = now - punchInDate;
            const diffSec = Math.floor(diffMs / 1000);
            
            const hours = Math.floor(diffSec / 3600);
            const minutes = Math.floor((diffSec % 3600) / 60);
            const seconds = diffSec % 60;
            
            timerElement.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // Update progress bar (9 hours = 100%)
            const targetHours = 9;
            const progressPercent = Math.min((diffSec / (targetHours * 3600)) * 100, 100);
            progressElement.style.width = `${progressPercent}%`;
            
            if (hours >= targetHours) {
                progressElement.classList.remove('bg-success');
                progressElement.classList.add('bg-primary');
            }
        }
        
        // Update immediately and then every second
        updateTimer();
        setInterval(updateTimer, 1000);
    }
});
</script>